{% extends "base.html" %}
{% block title %}서버 자산 관리 · SOMS{% endblock %}

{% block content %}
<div class="py-4">
  <div class="container-fluid">

    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h4 class="fw-bold mb-1">서버 자산 관리</h4>
        <div class="text-muted">전체 서버 관리 및 신규 등록 (총 {{ pagination.total }}건)</div>
      </div>
      <button class="btn btn-primary px-4 fw-bold shadow-sm" onclick="openServerRegister()">
        <i class="bi bi-hdd-rack-fill me-1"></i> 서버 등록
      </button>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body bg-light rounded-3 p-3">
            <form class="row g-2 align-items-end" method="get" action="{{ url_for('asset.list_servers') }}">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-secondary mb-1">검색어</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" name="q" value="{{ q or '' }}" placeholder="서버명, IP, 고객사명">
                    </div>
                </div>
                <div class="col-auto">
                    <button class="btn btn-secondary fw-bold px-4" type="submit">조회</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" style="width: 100%; min-width: 1000px;">
            <thead class="table-light">
              <tr>
                <th class="ps-4 py-3 text-secondary fw-bold" style="width: 5%;">No</th>
                <th class="py-3 text-secondary fw-bold" style="width: 15%;">고객사</th>
                <th class="py-3 text-secondary fw-bold" style="width: 15%;">사이트</th>
                <th class="py-3 text-secondary fw-bold" style="width: 25%;">서버 이름 (Hostname)</th>
                <th class="py-3 text-secondary fw-bold" style="width: 20%;">IP 주소</th>
                <th class="py-3 text-secondary fw-bold" style="width: 10%;">등록자</th>
                <th class="pe-4 py-3 text-secondary fw-bold text-end" style="width: 10%;">등록일</th>
              </tr>
            </thead>
            <tbody style="font-size: 0.9rem;">
              {% for s, c in pagination.items %}
              <tr class="clickable-row" onclick="openServerDetail(this)"
                  data-id="{{ s.Server_ID }}"
                  data-name="{{ s.chServerName }}"
                  data-ip="{{ s.chServerInfo }}"
                  data-company="{{ c.Company }}"
                  data-site="{{ c.Last_Name }}"
                  data-submitter="{{ s.Submitter or 'System' }}"
                  data-created="{{ s.Create_Date.strftime('%Y-%m-%d') if s.Create_Date else '-' }}">

                <td class="ps-4 text-muted small">
                    {{ pagination.total - ((pagination.page - 1) * pagination.per_page) - loop.index0 }}
                </td>
                <td><div class="fw-bold text-dark">{{ c.Company }}</div></td>
                <td><div class="text-dark">{{ c.Last_Name or '-' }}</div></td>
                <td>
                  <div class="fw-bold text-primary">
                      <i class="bi bi-server me-2"></i>{{ s.chServerName }}
                  </div>
                </td>
                <td>
                  <span class="font-monospace bg-light border px-2 py-1 rounded text-dark small">
                    {{ s.chServerInfo or '-' }}
                  </span>
                </td>
                <td><span class="text-secondary small">{{ s.Submitter or '-' }}</span></td>
                <td class="pe-4 text-end text-muted small">
                  {{ s.Create_Date.strftime('%Y-%m-%d') if s.Create_Date else '-' }}
                </td>
              </tr>
              {% endfor %}

              {% if not pagination.items %}
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="text-muted">
                      <i class="bi bi-inbox fs-1 d-block mb-3 opacity-25"></i>
                      등록된 서버 데이터가 없습니다.
                  </div>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if pagination.pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link border-0 rounded-circle mx-1" href="{{ url_for('asset.list_servers', page=pagination.prev_num, q=q) if pagination.has_prev else '#' }}">&laquo;</a>
            </li>
            {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if p %}
                    {% if p == pagination.page %}
                    <li class="page-item active"><span class="page-link border-0 rounded-circle mx-1">{{ p }}</span></li>
                    {% else %}
                    <li class="page-item"><a class="page-link border-0 rounded-circle mx-1 text-secondary" href="{{ url_for('asset.list_servers', page=p, q=q) }}">{{ p }}</a></li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link border-0 mx-1">...</span></li>
                {% endif %}
            {% endfor %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link border-0 rounded-circle mx-1" href="{{ url_for('asset.list_servers', page=pagination.next_num, q=q) if pagination.has_next else '#' }}">&raquo;</a>
            </li>
        </ul>
    </nav>
    {% endif %}

  </div>
</div>

<div class="modal fade" id="serverDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0 pb-4 px-4 bg-light">
                <div class="card border-0 shadow-sm mb-3 mt-2 overflow-hidden">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 56px; height: 56px;">
                                <i class="bi bi-hdd-rack-fill fs-3"></i>
                            </div>
                            <div>
                                <h4 class="fw-bold text-dark mb-1" id="detail_name">-</h4>
                                <div class="text-muted small">
                                    <i class="bi bi-building me-1"></i>
                                    <span id="detail_customer">-</span> / <span id="detail_site">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white border rounded p-3">
                            <label class="small text-secondary fw-bold mb-1">IP Address</label>
                            <div class="font-monospace fs-5 text-dark fw-bold" id="detail_ip">-</div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                            <span class="text-muted small">등록자</span>
                            <span class="fw-bold text-dark small" id="detail_submitter">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted small">등록일</span>
                            <span class="fw-bold text-dark small" id="detail_created">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 pb-4 pe-4 bg-light">
                <button type="button" class="btn btn-light border shadow-sm px-4" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="serverCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" method="post" action="{{ url_for('asset.list_servers') }}">

      <div class="modal-header bg-white border-bottom-0 py-3">
        <h5 class="modal-title fw-bold text-primary">
          <i class="bi bi-hdd-rack me-2"></i>신규 서버 등록
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>

      <div class="modal-body bg-light p-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="row g-3">

              <div class="col-12">
                <label class="form-label fw-bold small text-secondary">사이트명 <span class="text-danger">*</span></label>
                <select class="form-select select2-server" id="modal_person_id" name="Person_ID" required style="width: 100%;">
                    <option value="">사이트를 검색하세요</option>
                    {% for cust in customers %}
                        <option value="{{ cust.Person_ID }}" data-company="{{ cust.Company }}">
                            {{ cust.Last_Name or cust.Company }}
                        </option>
                    {% endfor %}
                </select>
              </div>

              <div class="col-12">
                <label class="form-label fw-bold small text-secondary">고객사 (자동 입력)</label>
                <input type="text" class="form-control bg-light" id="modal_auto_company" readonly>
              </div>

              <div class="col-12"><hr class="dashed my-1"></div>

              <div class="col-12">
                <label class="form-label fw-bold small text-secondary">서버 이름 (Hostname) <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="server_name" placeholder="예: WEB-SVR-01" required>
              </div>

              <div class="col-12">
                <label class="form-label fw-bold small text-secondary">IP 주소</label>
                <input type="text" class="form-control font-monospace" name="server_ip" placeholder="예: 192.168.10.10">
              </div>

            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer bg-white border-top-0 py-3">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">취소</button>
        <button type="submit" class="btn btn-primary px-4 fw-bold">등록하기</button>
      </div>

    </form>
  </div>
</div>

<script>

</script>
{% endblock %}